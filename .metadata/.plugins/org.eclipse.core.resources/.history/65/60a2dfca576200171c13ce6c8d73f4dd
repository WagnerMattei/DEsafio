package com.eits.desafio.domain.service;

import java.time.LocalDate;

import org.directwebremoting.annotations.RemoteProxy;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Sort.Direction;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.eits.desafio.domain.entity.Conta;
import com.eits.desafio.domain.repository.IContasRepository;

@Service 
@RemoteProxy(name="contaService")
@Transactional
public class ContaService
{
	
	@Autowired 
	private IContasRepository contasRepository;
	
	@Autowired 
	private UsuarioService usuarioService;;
	
	

	/**
	 * 
	 * @param conta
	 * @return
	 * INSERT
	 */
	
	public ResponseEntity<String> insert(Conta conta)
	{
		//Verifica se o objeto chegou vazio
		if (conta.equals(null))
		{
			return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body("Conta indefinido");
		}
		if(contasRepository.findByNome(conta.getNome()) != null)
		{
			return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body("Nome ja em uso");
		}
		conta.setDataCadastro(LocalDate.now());
		conta.setSaldo(0);
		conta.setCriador(usuarioService.getCurrent());
		contasRepository.save(conta);
		return ResponseEntity.status(HttpStatus.ACCEPTED).body("Conta salva com sucesso!");
		
	}
	/**
	 * 
	 * @param numero
	 * @return
	 * FIND BY NUMERO
	 */
	public Conta findByNumero(long numero)
	{
		 return contasRepository.findOne(numero);

	}
	
	/**
	 * 
	 * @param page
	 * @param size
	 * @return
	 * LIST
	 */


	//LIST//
	// Método que retorna a lista de contas
	public Page<Conta> list(int page, int size, String property, String order) 
	{
		Direction asc;
		asc = Direction.ASC;
		PageRequest pageable = new PageRequest(page, size, asc, property);
		System.out.println(pageable);
		return contasRepository.findAll(pageable);
	}

	/**
	 * 
	 * @param filter
	 * @param page
	 * @param size
	 * @return
	 * LIST CONTAS BY FILTERS
	 */
	//LIST CONTAS BY FILTERS//
	//Metodo para filtrar contas
	public Page<Conta> listContasByFilters(String filter, int page, int size, String property, String order)
	{
		Direction asc;
		asc = Direction.ASC;
		PageRequest pageable = new PageRequest(page, size, asc, property);
		System.out.println(pageable);
		return contasRepository.listContasByFilters(filter, pageable);
	}
	
	/**
	 * 
	 * @param conta
	 * @return
	 * UPDATE
	 */
	public ResponseEntity<String> update(Conta conta)
	{
		//Verifica se o objeto chegou vazio
		if (conta.equals(null))
		{
			return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body("Conta indefinido");
		}

		Conta contaAntiga = new Conta();
		contaAntiga = contasRepository.findOne(conta.getNumero());  
		
		//Verifica se o nome do usuario é repetido
		if ((contasRepository.findByNome(conta.getNome()) != null) )
		{
			if (!(contaAntiga.getNome().equals(conta.getNome())))
			{
				return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body("Nome ja em uso");
			}
		}
		conta.setDataAlteracao(LocalDate.now());
		Conta novaConta = new Conta(); 
		novaConta = contasRepository.findOne(conta.getNumero());
		conta.setDataCadastro(novaConta.getDataCadastro());
		conta.setUltimoAlterador(usuarioService.getCurrent());
		contasRepository.saveAndFlush(conta);
		return ResponseEntity.status(HttpStatus.ACCEPTED).body("Conta salva com sucesso!");
	}

	/**
	 * 
	 * @param numero
	 * REMOVE
	 */
	@PreAuthorize("hasRole('ADMINISTRADOR')")
	public ResponseEntity<String> remove(Long numero)
	{
		if (this.contasRepository.findOne(numero).getSaldo() < 0)
		{
			return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body("Não é possivel remover uma conta com saldo negativo");
		}
		this.contasRepository.delete(numero);
		return ResponseEntity.status(HttpStatus.ACCEPTED).body("Conta removida com sucesso");
	}
	
	
	

	
}
